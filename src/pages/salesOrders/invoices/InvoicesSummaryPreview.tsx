import { useSearchParams } from "react-router";
import { useEffect, useState } from "react";
import { useLazyGetInvoiceByIdQuery, useLazyGetOrdersItemsQuery } from "@/store/features/salesOrder/salesOrder";
import { useGetSettingsInfoQuery } from "@/store/features/admin/settingsApiService";
import PrintableInvoicesSummary from "./PrintableInvoicesSummary";
import type { SalesInvoice } from "@/types/salesInvoice.types";
import { Loader2 } from "lucide-react";

export default function InvoicesSummaryPreview() {
    const [searchParams] = useSearchParams();
    const idsParam = searchParams.get("ids");
    const [invoices, setInvoices] = useState<SalesInvoice[]>([]);
    const [loading, setLoading] = useState(true);

    const [triggerGetInvoice] = useLazyGetInvoiceByIdQuery();
    const [triggerGetOrdersItems] = useLazyGetOrdersItemsQuery();
    const { data: settingsData } = useGetSettingsInfoQuery();

    useEffect(() => {
        async function fetchInvoices() {
            if (!idsParam) {
                setLoading(false);
                return;
            }

            const ids = idsParam.split(",").map(Number);
            try {
                const fetchPromises = ids.map(id => triggerGetInvoice(id).unwrap());
                const results = await Promise.all(fetchPromises);
                const fetchedInvoices = results
                    .map(res => res.data)
                    .filter((inv): inv is SalesInvoice => !!inv);

                // Fetch Items details for all orders in batch
                const orderIds = fetchedInvoices.map(inv => inv.order_id).filter(Boolean).join(",");
                if (orderIds) {
                    try {
                        const itemsResponse = await triggerGetOrdersItems(orderIds).unwrap();
                        console.log('itemsResponse', itemsResponse);
                        if (itemsResponse.status && Array.isArray(itemsResponse.data)) {
                            // Merge items into invoices
                            const mergedInvoices = fetchedInvoices.map(inv => {
                                const orderData = itemsResponse.data.find((d: any) => d.id === inv.order_id);
                                if (orderData && orderData.items) {
                                    return {
                                        ...inv,
                                        order: {
                                            ...inv.order,
                                            items: orderData.items
                                        }
                                    };
                                }
                                return inv;
                            });
                            setInvoices(mergedInvoices);
                        } else {
                            setInvoices(fetchedInvoices);
                        }
                    } catch (err) {
                        console.error("Error fetching batch items:", err);
                        setInvoices(fetchedInvoices);
                    }
                } else {
                    setInvoices(fetchedInvoices);
                }
            } catch (error) {
                console.error("Error fetching invoices for summary:", error);
            } finally {
                setLoading(false);
            }
        }

        fetchInvoices();
    }, [idsParam, triggerGetInvoice, triggerGetOrdersItems]);

    if (loading) {
        return (
            <div className="flex h-screen items-center justify-center gap-2 font-medium">
                <Loader2 className="h-6 w-6 animate-spin text-blue-600" />
                <span>Loading summary data...</span>
            </div>
        );
    }

    if (invoices.length === 0) {
        return (
            <div className="flex h-screen items-center justify-center text-gray-500 font-medium">
                No invoices selected for summary.
            </div>
        );
    }

    const isFullSummary = searchParams.get("full") === "true";

    return (
        <div className="py-8">
            <PrintableInvoicesSummary
                invoices={invoices}
                from={settingsData?.data}
                itemsOnly={!isFullSummary}
            />
        </div>
    );
}
